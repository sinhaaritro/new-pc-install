# **Setting up Recovery with BTRFS filesystem and snapper**

This guide provides step-by-step instructions for setting up the subvolumes of BTRFS. 

---

## **Table of Contents**
1. [Prerequisites](#prerequisites)
2. [Creating subvolumes](#creating-subvolumes)
3. [Creating folders](#creating-folders)
4. [Mounting the File System of Root Partition](#mounting-the-file-system-of-root-partition)
5. [Install extra packages](#install-extra-packages)
6. [Generate fstab](#generate-fstab)
7. [GO BACK TO MAIN GUIDE](#go-back-to-main-guide)
8. [Edit mkinitcpio](#edit-mkinitcpio)

---

## **Prerequisites**
This guide considers that we have already partitioned the drive into 3 parts but did not format the root partition.

## **Creating subvolumes**
We need to mount the partitions we created into our Linux hierarchy. First, we need to mount sda3 (root) into /mnt.
```bash
mount /dev/sda3 /mnt
```

We will create subvolumes to organize our data better and exclude them from BTRFS snapshots.
The subvolumes are:
- @ – This is the main root subvolume /.
- @home – This is the home directory. This consists of most of your data including Desktop and Downloads.
- @root – 
- @log – Contains logs, temp. files, caches, games, etc.
- @pkg – Contains all the pacman packages
- @tmp – Contains certain temporary files and caches
- @snapshots – Directory to store snapshots.

> [!TIP]
> We can use short forms of the command
> - su = subvolume
> - cr = create
> - li = list

The commands are
```bash
btrfs subvolume create /mnt/@
btrfs subvolume create /mnt/@home
btrfs subvolume create /mnt/@root
btrfs subvolume create /mnt/@srv
btrfs subvolume create /mnt/@log
btrfs subvolume create /mnt/@cache
btrfs subvolume create /mnt/@tmp
btrfs subvolume create /mnt/@snapshots
```
> [!NOTE]
> To view the list of subvolumes we can use the command `btrfs subvolume list /mnt`

## **Creating folders**
Unmount `/mnt` and remount all subvolumes
```bash
umount /mnt
```

Mount only the main partition and create the folders for the subvolumes mount point
```bash
mount -o defaults,noatime,compress=zstd,space_cache=v2,commit=120,subvol=@ /dev/sdz3 /mnt
mkdir  /mnt/home
mkdir  /mnt/root
mkdir  /mnt/srv
mkdir -p /mnt/var/log
mkdir -p /mnt/var/cache/
mkdir /mnt/tmp
mkdir /mnt/.snapshots
```

> [!TIP]
> We can use the one-liner
> `mkdir -p /mnt/{home,root,srv,var/log,var/cache,tmp,.snapshots}`

We can use `lsblk` to check the mount points

## **Mounting the File System of Root Partition**
Btrfs options:
- noatime – No access time. Improves system performance by not writingthe  time when the file was accessed.
- commit – Periodic interval (in sec) in which data is synchronized to permanent storage.
- compress – Choose the algorithm for compressiom. I have set zstd as it has a good compression level and speed.
- subvol – Choosing the subvol to mount.
- space_cache

The command for mounting all the subvolumes are
```bash
mount -o defaults,noatime,compress=zstd,space_cache=v2,commit=120,subvol=@home /dev/sdz3 /mnt/home
mount -o defaults,noatime,compress=zstd,space_cache=v2,commit=120,subvol=@root /dev/sdz3 /mnt/root
mount -o defaults,noatime,compress=zstd,space_cache=v2,commit=120,subvol=@srv /dev/sdz3 /mnt/srv
mount -o defaults,noatime,compress=zstd,space_cache=v2,commit=120,subvol=@log /dev/sdz3 /mnt/var/log
mount -o defaults,noatime,compress=zstd,space_cache=v2,commit=120,subvol=@cache /dev/sdz3 /mnt/var/cache
mount -o defaults,noatime,compress=zstd,space_cache=v2,commit=120,subvol=@tmp /dev/sdz3 /mnt/tmp
mount -o defaults,noatime,compress=zstd,space_cache=v2,commit=120,subvol=@snapshots /dev/sdz3 /mnt/.snapshots
```

## **Install extra packages**
Add any specific BTRFS packages later when installing `pacstrap`.
```bash
pacstrap /mnt btrfs-progs
```

## **Generate fstab**
1. Fstab `genfstab -U /mnt >> /mnt/etc/fstab`
2. Check there are all entries (1 for efi, 1 for swap, 1 for root, 7 for subvolumes) in the file `cat /mnt/etc/fstab`

## **GO BACK TO MAIN GUIDE**
Go back to main guide and start from #Install

## **Edit mkinitcpio**
> [!IMPORTANT]
> Return to this part of the guide after bootloader installation

1. Edit `mkinitcpio.conf` file by `sudo nvim /etc/mkinitcpio.conf`
2. Find the line that says `MODULES=()`
3. New line will be `MODULES=(... btrfs ...)`
4. Save `:wq`
5. Regenerate the initramfs with `sudo mkinitcpio -P`





