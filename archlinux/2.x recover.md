# **Setting up Recovery with BTRFS filesystem and snapper**

This guide provides **step-by-step instructions** for setting up **BTRFS subvolumes** and configuring **Snapper**.

---

## **Table of Contents**
1. [**Prerequisites**](#prerequisites)
2. [**Creating Subvolumes**](#creating-subvolumes)
3. [**Creating Folders**](#creating-folders)
4. [**Mounting the File System of Root Partition**](#mounting-the-file-system-of-root-partition)
5. [**Installing Extra Packages**](#installing-extra-packages)
6. [**Generating fstab**](#generating-fstab)
7. [**Return to Main Guide 1**](#return-to-main-guide-1)
8. [**Editing mkinitcpio**](#editing-mkinitcpio)
9. [**Return to Main Guide 2**](#return-to-main-guide-2)
10. [**Recreating the Snapshot Directory for Snapper**](#recreating-the-snapshot-directory-for-snapper)

---

## **Prerequisites**
- Ensure the drive is already **partitioned into 3 parts**, but the **root partition is not formatted**.
- Required packages:  
  `btrfs-progs snapper`

---

## **Creating subvolumes**
Mount the **root partition** (`sdz3`) into `/mnt`:
```bash
mount /dev/sdz3 /mnt
```

Create the following **subvolumes** to organize data and exclude them from snapshots:

- **@**: Main root subvolume `/`
- **@home**: Home directory (e.g., Desktop, Downloads)
- **@root**
  **@svr**: Server Files
- **@log**: Logs, temp files, caches, games
- **@pkg**: Pacman packages
- **@tmp**: Temporary files and caches
- **@snapshots**: Stores snapshots

> [!TIP]
> **Short forms of the command:**
> - su = subvolume
> - cr = create
> - li = list

The commands are
```bash
btrfs subvolume create /mnt/@
btrfs subvolume create /mnt/@home
btrfs subvolume create /mnt/@root
btrfs subvolume create /mnt/@srv
btrfs subvolume create /mnt/@log
btrfs subvolume create /mnt/@cache
btrfs subvolume create /mnt/@tmp
btrfs subvolume create /mnt/@snapshots
```
> [!NOTE]
> Use `btrfs subvolume list /mnt` to view the list of subvolumes.

## **Creating folders**
Unmount `/mnt` and remount the **main partition**:
```bash
umount /mnt
mount -o defaults,noatime,compress=zstd,space_cache=v2,commit=120,subvol=@ /dev/sdz3 /mnt
```

---

Create **folders** for subvolumes:
```bash
mkdir  /mnt/home
mkdir  /mnt/root
mkdir  /mnt/srv
mkdir -p /mnt/var/log
mkdir -p /mnt/var/cache/
mkdir /mnt/tmp
mkdir /mnt/.snapshots
```

> [!TIP]
> **One-liner for folder creation:** 
> `mkdir -p /mnt/{home,root,srv,var/log,var/cache,tmp,.snapshots}`

We can use `lsblk` to check the mount points

---

## **Mounting the File System of Root Partition**
Mount all **subvolumes** with the following options:
- **noatime**: Disables access time updates for improved performance.
- **commit**: Interval (in seconds) for syncing data to storage.
- **compress**: Compression algorithm (use `zstd` for a good balance of speed and compression).
- **subvol**: Specifies the subvolume to mount.
- **space_cache**: Optimizes space management.

**Mount commands:**
```bash
mount -o defaults,noatime,compress=zstd,space_cache=v2,commit=120,subvol=@home /dev/sdz3 /mnt/home
mount -o defaults,noatime,compress=zstd,space_cache=v2,commit=120,subvol=@root /dev/sdz3 /mnt/root
mount -o defaults,noatime,compress=zstd,space_cache=v2,commit=120,subvol=@srv /dev/sdz3 /mnt/srv
mount -o defaults,noatime,compress=zstd,space_cache=v2,commit=120,subvol=@log /dev/sdz3 /mnt/var/log
mount -o defaults,noatime,compress=zstd,space_cache=v2,commit=120,subvol=@cache /dev/sdz3 /mnt/var/cache
mount -o defaults,noatime,compress=zstd,space_cache=v2,commit=120,subvol=@tmp /dev/sdz3 /mnt/tmp
mount -o defaults,noatime,compress=zstd,space_cache=v2,commit=120,subvol=@snapshots /dev/sdz3 /mnt/.snapshots
```

---

## **Installing Extra Packages**
Add **specific BTRFS packages** when using `pacstrap`:
```bash
pacstrap /mnt btrfs-progs snapper
```

## **Generating fstab**
1. Generate the **fstab** file:
   ```bash
   genfstab -U /mnt >> /mnt/etc/fstab
   ```
2. Verify all entries:
   ```bash
   cat /mnt/etc/fstab
   ```
   Ensure entries include:
   - **1 EFI**
   - **1 Swap**
   - **1 Root**
   - **7 Subvolumes**

---

## **Return to Main Guide 1**
Continue from the **Install** section of the main guide.

---

## **Editing mkinitcpio**
> [!IMPORTANT]
> Perform this step **before bootloader installation**.

1. Edit `mkinitcpio.conf`:
   ```bash
   sudo nvim /etc/mkinitcpio.conf
   ```
2. Locate the line:  
   **`MODULES=()`**
3. Modify it to:  
   **`MODULES=(... btrfs ...)`**
4. Save changes:  
   `:wq`
5. Regenerate **initramfs**:  
   ```bash
   sudo mkinitcpio -P
   ```

---

## **Return to Main Guide 2**
Continue from the **Bootloader Install** section of the main guide.

---

## **Recreating the Snapshot Directory for Snapper**
1. **Unmount and remove the `.snapshots` directory:**
   ```bash
   sudo umount /.snapshots
   sudo rm -r /.snapshots
   ```

2. **Create Snapper root configuration:**
   ```bash
   sudo snapper -C root create-config /
   ```

> [!CAUTION]  
> This creates an **extra snapshot subvolume**. Delete it, as it's unnecessary.

3. **Delete the extra subvolume:**
   ```bash
   sudo btrfs subvolume delete /.snapshots
   ```

4. **Recreate and mount the snapshot directory:**
   ```bash
   sudo mkdir /.snapshots
   sudo mount -a
   sudo chmod 750 /.snapshots
   ```

> [!WARNING]
> Ensure the **fstab file** has the correct mounting instructions. Regenerate it if required.







