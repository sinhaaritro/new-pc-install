# Installing Nvidia drivers

https://wiki.archlinux.org/title/NVIDIA

---

# **Table of Contents**
- [**Prerequisites**](#prerequisites)
- [**Process**](#Process)
  - [Step 1: Enable multilib repository](#step-1-enable-multilib-repository)
  - [Step 2: Installing the driver packages](#step-2-installing-the-driver-packages)
  - [Step 3: Setup the Kernel Parameter for GRUB users](#step-3-setup-the-kernel-parameter-for-grub-users)
  - [Step 4: Early Loading of NVIDIA Modules](#step-4-early-loading-of-nvidia-modules)
  - [Step 5: Add the Pacman Hook](#step-5-add-the-pacman-hook)
  - [Step 6: Reboot](#step-6-reboot)

---
# Prerequisites
- Ensure Arch is installed and we have booted from the actual environment.
- Required packages:  
  `nvidia-open nvidia-utils lib32-nvidia-utils nvidia-settings`

---

# Process
## Step 1: Enable multilib repository
1. Run `sudo nvim /etc/pacman.conf`
2. Uncomment the line `[multilib]`
3. Uncomment the line `Include = /etc/pacman.d/mirrorlist`
4. Update pacman database `pacman -Syu`

## Step 2: Installing the driver packages
1. Find the Card name from https://nouveau.freedesktop.org/CodeNames.html 
2. Get the package name from the table
    | **_Driver name_**                                           	| **_Kernel_**     	| **_Base driver_** 	| **_OpenGL_**       	| **_OpenGL (multilib)_**  	|
    |-------------------------------------------------------------	|------------------	|-------------------	|--------------------	|--------------------------	|
    | **Turing (NV160/TUXXX) and newer**                          	| linux            	| nvidia-open       	| nvidia-utils       	| lib32-nvidia-utils       	|
    | **Turing (NV160/TUXXX) and newer**                          	| any other kernel 	| nvidia-open-dkms  	| nvidia-utils       	| lib32-nvidia-utils       	|
    | **Maxwell (NV110) series up to Ada Lovelace (NV190/ADXXX)** 	| linux            	| nvidia            	| nvidia-utils       	| lib32-nvidia-utils       	|
    | **Maxwell (NV110) series up to Ada Lovelace (NV190/ADXXX)** 	| linux-lts        	| nvidia            	| nvidia-utils       	| lib32-nvidia-utils       	|
    | **Maxwell (NV110) series up to Ada Lovelace (NV190/ADXXX)** 	| any other kernel 	| nvidia-dkms       	| nvidia-utils       	| lib32-nvidia-utils       	|
    | **Kepler (NVE0) series**                                    	| any              	| nvidia-470xx-dkms 	| nvidia-470xx-utils 	| lib32-nvidia-470xx-utils 	|
    | **GeForce 400/500/600 series cards [NVCx and NVDx]**        	| any              	| nvidia-390xx-dkms 	| nvidia-390xx-utils 	| lib32-nvidia-390xx-utils 	|
    | **Tesla (NV50/G80-90-GT2XX)**                               	| any              	| nvidia-340xx-dkms 	| nvidia-340xx-utils 	| lib32-nvidia-340xx-utils 	|

3. Run `pacman -S nvidia-open nvidia-utils lib32-nvidia-utils nvidia-settings`

## Step 3: Setup the Kernel Parameter for GRUB users
1. Edit GRUB file by `sudo nvim /etc/default/grub`
2. Find the line with **GRUB_CMDLINE_LINUX_DEFAULT**
3. The new line will be `GRUB_CMDLINE_LINUX_DEFAULT="[... nvidia-drm.modeset=1 nvidia-drm.fbdev=1]"`
3. Save `:wq`
4. Update GRUB configuration `sudo grub-mkconfig -o /boot/grub/grub.cfg`

## Step 4: Early Loading of NVIDIA Modules
1. Edit `mkinitcpio.conf` file by `sudo nvim /etc/mkinitcpio.conf`
2. Find the line that says `MODULES=()`
3. New line will be `MODULES=(... nvidia nvidia_modeset nvidia_uvm nvidia_drm ...)`
4. Find the line that says `HOOKS=(...)`
5. On the line delete the word `kms` and save
6. Regenerate the initramfs with `sudo mkinitcpio -P`

## Step 5: Add the Pacman Hook
1. Create the hooks directory `sudo mkdir -p /etc/pacman.d/hooks/`
2. Create the file `nvim /etc/pacman.d/hooks/nvidia.hook`
3. Copy paste the following code and save
    ```text
    [Trigger]
    Operation=Install
    Operation=Upgrade
    Operation=Remove
    Type=Package
    # Should match your base driver package, e.g. Target=nvidia-470xx-dkms
    Target=nvidia
    # Should match your kernel package, e.g. Target=linux-lts
    Target=linux
    
    [Action]
    Description=Update Nvidia module in initcpio
    Depends=mkinitcpio
    When=PostTransaction
    NeedsTargets
    Exec=/bin/sh -c 'while read -r trg; do case $trg in linux) exit 0; esac; done; /usr/bin/mkinitcpio -P'
    ```

## Step 6: Reboot
1. Run `nvidia-smi` to get card details
